'use client'

import { ApiError } from '@/lib/axios'
import { useBulkChangeStatusMutation, useJobStatuses } from '@/lib/queries'
import {
    addToast,
    Button,
    Modal,
    ModalBody,
    ModalContent,
    ModalFooter,
    ModalHeader,
} from '@heroui/react'
import { useStore } from '@tanstack/react-store'
import { useTranslations } from 'next-intl'
import { useState } from 'react'
import { pCenterTableStore } from '../../stores'
import { HeroSelect, HeroSelectItem } from '../ui/hero-select'

type Props = {
    isOpen: boolean
    onClose: () => void
    isLoading?: boolean
}
export default function BulkChangeStatusModal({ isOpen, onClose }: Props) {
    const [toStatusId, setToStatusId] = useState<string | null>(null)

    const selectedKeys = useStore(
        pCenterTableStore,
        (state) => state.selectedKeys
    )

    const { data: jobStatuses, isLoading: loadingJobStatuses } =
        useJobStatuses()

    const { mutateAsync: bulkChangeStatusMutate, isPending: isUpdating } =
        useBulkChangeStatusMutation()

    const t = useTranslations()

    const handleClose = () => {
        onClose()
    }

    const onSubmit = async () => {
        if (toStatusId) {
            await bulkChangeStatusMutate(
                {
                    data: {
                        jobIds:
                            selectedKeys !== 'all'
                                ? Array.from(selectedKeys)
                                : [],
                        toStatusId,
                    },
                },
                {
                    onSuccess: (res) => {
                        addToast({
                            title: t('success'),
                            description: res.data.message,
                            color: 'success',
                        })
                    },
                    onError: (error) => {
                        const err = error as unknown as ApiError
                        addToast({
                            title: t('failed'),
                            description: err.message,
                            color: 'danger',
                        })
                        pCenterTableStore.setState((state) => ({
                            ...state,
                            selectedKeys: new Set(),
                        }))
                    },
                }
            )
        } else {
            addToast({
                title: t('failed'),
                description: 'Please choose status to change',
                color: 'danger',
            })
        }
    }

    return (
        <Modal
            isOpen={isOpen}
            onClose={handleClose}
            placement="center"
            hideCloseButton
            classNames={{
                base: '!p-0',
            }}
            size="lg"
        >
            <ModalContent className="p-2">
                <ModalHeader
                    className="text-white"
                    style={{
                        backgroundColor: 'var(--color-primary)',
                    }}
                >
                    <div className="space-y-1">
                        <p className="font-semibold text-lg">
                            Bulk change status for{' '}
                            {selectedKeys === 'all'
                                ? 'all items'
                                : `${selectedKeys.size} items`}
                        </p>
                        <p className="text-xs font-normal text-text-subdued">
                            Update the status for multiple jobs at once.
                        </p>
                    </div>
                </ModalHeader>
                <ModalBody>
                    <div className="pt-2.5 px-0 space-y-3">
                        <p className="text-text-subdued text-sm">
                            Select the new status you want to apply to all
                            selected jobs.
                        </p>
                        <HeroSelect
                            isLoading={loadingJobStatuses}
                            id="status"
                            name="status"
                            placeholder="Select status ..."
                            selectionMode="single"
                            onChange={(e) => {
                                const value = e.target.value
                                setToStatusId(value)
                            }}
                            size="lg"
                            renderValue={(selectedItems) => {
                                return (
                                    <ul className="flex line-clamp-1 truncate">
                                        {selectedItems.map((jobStatus) => {
                                            const item = jobStatuses?.find(
                                                (d) => d.id === jobStatus.key
                                            )
                                            if (!item)
                                                return (
                                                    <span
                                                        className="text-gray-400"
                                                        key={jobStatus.key}
                                                    >
                                                        Select one job status
                                                    </span>
                                                )
                                            return (
                                                <div
                                                    key={jobStatus.key}
                                                    className="flex items-center gap-2"
                                                >
                                                    <div
                                                        className="w-2 h-2 rounded-full"
                                                        style={{
                                                            backgroundColor:
                                                                item.hexColor ||
                                                                'transparent',
                                                        }}
                                                    />
                                                    <span>
                                                        {item.displayName}
                                                    </span>
                                                </div>
                                            )
                                        })}
                                    </ul>
                                )
                            }}
                        >
                            {jobStatuses?.map((jobStatus) => (
                                <HeroSelectItem key={jobStatus.id}>
                                    <div className="flex items-center justify-start gap-2">
                                        <div
                                            className="size-2 rounded-full"
                                            style={{
                                                backgroundColor:
                                                    jobStatus.hexColor
                                                        ? jobStatus.hexColor
                                                        : 'transparent',
                                            }}
                                        />
                                        <p>{jobStatus.displayName}</p>
                                    </div>
                                </HeroSelectItem>
                            ))}
                        </HeroSelect>
                    </div>
                </ModalBody>
                <ModalFooter>
                    <Button variant="light" onPress={handleClose}>
                        {t('cancel')}
                    </Button>
                    <Button
                        color="primary"
                        isLoading={isUpdating}
                        onPress={onSubmit}
                    >
                        {t('reset')}
                    </Button>
                </ModalFooter>
            </ModalContent>
        </Modal>
    )
}
