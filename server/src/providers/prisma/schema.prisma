// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

generator docs {
  provider = "node node_modules/prisma-docs-generator"
  output   = "./docs"
}

// generator erd {
//   provider = "prisma-erd-generator"
//   theme    = "forest"
//   output   = "../ERD.svg"
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String           @id @default(uuid())
  email               String           @unique
  username            String           @unique
  displayName         String
  password            String
  avatar              String?
  jobTitles           JobTitle[]       @relation("UserJobTitles")
  departmentId        String?
  department          Department?      @relation(fields: [departmentId], references: [id])
  phoneNumber         String?
  role                RoleEnum         @default(USER)
  isActive            Boolean          @default(true)
  lastLoginAt         DateTime?
  notifications       Notification[]   @relation("UserNotifications")
  jobsAssigned        Job[]            @relation("UserJobs") // Jobs assigned 
  jobsCreated         Job[]            @relation("JobCreator")
  filesCreated        FileSystem[]     @relation("CreatedFiles")
  files               FileSystem[]     @relation("UserFiles")
  accounts            Account[]
  sendedNotifications Notification[]   @relation("UserSendedNotifications")
  jobActivityLog      JobActivityLog[]
  configs             Config[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  Comment             Comment[]
}

model Comment {
  id      String @id @default(uuid())
  content String
  jobId   String
  job     Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentId String? // Hỗ trợ reply comment
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([userId])
  @@index([createdAt])
}

model JobTitle {
  id          String   @id @default(uuid())
  displayName String
  notes       String?
  code        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]   @relation("UserJobTitles")
}

model Department {
  id          String   @id @default(uuid())
  displayName String
  notes       String?
  code        String   @unique
  hexColor    String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Config {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  displayName String
  code        String
  value       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, code])
}

enum RoleEnum {
  USER
  ADMIN
  ACCOUNTING
}

model Account {
  id         String          @id @default(uuid())
  provider   AccountProvider
  providerId String
  userId     String
  user       User            @relation(fields: [userId], references: [id])

  @@unique([provider, providerId])
}

enum AccountProvider {
  GOOGLE
  GITHUB
  MICROSOFT
  FACEBOOK
  LOCAL
}

model FileSystem {
  id    String   @id @default(uuid())
  name  String
  type  String
  size  String
  items Int?
  path  String[]
  color String?

  createdById String
  createdBy   User   @relation("CreatedFiles", fields: [createdById], references: [id])

  visibleToUsers User[] @relation("UserFiles")

  // Link files to jobs
  job   Job?    @relation(fields: [jobId], references: [id])
  jobId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([jobId])
}

model Job {
  id               String           @id @default(uuid())
  no               String           @unique // Job No. example FV-0001
  type             JobType          @relation(fields: [typeId], references: [id])
  typeId           String
  displayName      String
  description      String?
  attachmentUrls   String[]         @default([])
  clientName       String
  incomeCost       Int
  staffCost        Int
  assignee         User[]           @relation("UserJobs") // Member assigned
  createdBy        User             @relation("JobCreator", fields: [createdById], references: [id])
  createdById      String
  paymentChannel   PaymentChannel   @relation(fields: [paymentChannelId], references: [id])
  paymentChannelId String
  status           JobStatus        @relation(fields: [statusId], references: [id])
  statusId         String
  activityLog      JobActivityLog[]
  startedAt        DateTime         @default(now())
  priority         JobPriority      @default(MEDIUM)
  files            FileSystem[]
  isPinned         Boolean          @default(false)
  isPublished      Boolean          @default(false)
  isPaid           Boolean          @default(false)
  dueAt            DateTime
  completedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  comment          Comment[]

  @@index([no])
  @@index([statusId])
  @@index([createdById])
  @@index([priority])
}

enum JobPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model PaymentChannel {
  id          String   @id @default(uuid())
  displayName String
  hexColor    String?
  logoUrl     String?
  ownerName   String?
  cardNumber  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jobs Job[]
}

model JobType {
  id          String   @id @default(uuid())
  code        String
  displayName String
  hexColor    String?
  jobs        Job[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobStatus {
  id              String   @id @default(uuid())
  displayName     String
  thumbnailUrl    String?
  hexColor        String
  order           Int      @unique
  icon            String?
  nextStatusOrder Int?
  prevStatusOrder Int?
  jobs            Job[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([order])
}

model JobActivityLog {
  id    String @id @default(uuid())
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId String

  previousValue String?
  currentValue  String?

  modifiedAt   DateTime @default(now())
  modifiedBy   User     @relation(fields: [modifiedById], references: [id])
  modifiedById String

  fieldName    String
  activityType ActivityType
  notes        String?

  @@index([jobId, modifiedAt])
  @@index([modifiedById])
}

enum ActivityType {
  CreateJob
  ChangeStatus
  AssignMember
  UnassignMember
  ChangePaymentChannel
  UpdateInformation
  DeleteJob
}

model Notification {
  id     String @id @default(uuid())
  /**
   * Người nhận thông báo
   */
  userId String
  user   User   @relation("UserNotifications", fields: [userId], references: [id])

  title    String?
  content  String
  imageUrl String?
  senderId String?
  sender   User?              @relation("UserSendedNotifications", fields: [senderId], references: [id])
  type     NotificationType   @default(INFO)
  status   NotificationStatus @default(UNSEEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([userId, status])
  @@index([createdAt])
}

enum NotificationStatus {
  SEEN
  UNSEEN
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  JOB_UPDATE
  DEADLINE_REMINDER
  STATUS_CHANGE
}
