// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BrowserSubscribes {
  id String @id @default(uuid())

  endpoint       String
  expirationTime String?
  p256dh         String
  auth           String
}

model UserDevices {
  id     String  @id @default(uuid())
  userId String
  user   User    @relation(fields: [userId], references: [id])
  type   String
  status Boolean @default(false)
  value  String
}

model User {
  id                  String             @id @default(uuid())
  email               String             @unique
  username            String             @unique
  displayName         String
  avatar              String
  jobTitleId          String?
  password            String
  emailVerified       Boolean            @default(false)
  jobTitle            JobTitle?          @relation(fields: [jobTitleId], references: [id])
  departmentId        String?
  department          Department?        @relation(fields: [departmentId], references: [id])
  phoneNumber         String?
  role                RoleEnum           @default(USER)
  isActive            Boolean            @default(true)
  lastLoginAt         DateTime?
  notifications       Notification[]     @relation("UserNotifications")
  jobsAssigned        Job[]              @relation("UserJobs") // Jobs assigned
  jobsCreated         Job[]              @relation("JobCreator")
  filesCreated        FileSystem[]       @relation("CreatedFiles")
  files               FileSystem[]       @relation("UserFiles")
  sendedNotifications Notification[]     @relation("UserSendedNotifications")
  jobActivityLog      JobActivityLog[]
  configs             UserConfig[]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  comment             Comment[]
  gallery             Gallery[]
  userDevices         UserDevices[]
  statusChanges       JobStatusHistory[]
  pinnedJobs          PinnedJob[]

  // Organization
  managerId String?
  manager   User?   @relation("UserHierarchy", fields: [managerId], references: [id])
  reports   User[]  @relation("UserHierarchy")

  // Quan hệ Auth
  sessions      Session[]
  accounts      Account[]
  jobDeliveries JobDelivery[]
}

// Model Session bắt buộc cho Better Auth
model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
}

// Model Account cần update để lưu Token từ Azure
model Account {
  id           String    @id @default(uuid())
  userId       String
  accountId    String // ID của user bên Azure
  providerId   String // Tên provider: "microsoft" hoặc "azure"
  accessToken  String?
  refreshToken String?
  idToken      String?
  expiresAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Xóa enum AccountProvider cũ vì Better Auth dùng string cho linh hoạt
}

// Model Verification bắt buộc cho Better Auth (xác thực email)
model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt // Thêm field này nếu Prisma báo lỗi thiếu
}

model Gallery {
  id          String   @id @default(uuid())
  title       String?
  description String?
  url         String
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id      String @id @default(uuid())
  content String
  jobId   String
  job     Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentId String? // Hỗ trợ reply comment
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([userId])
  @@index([createdAt])
}

model JobTitle {
  id          String   @id @default(uuid())
  displayName String
  notes       String?
  code        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model Department {
  id          String   @id @default(uuid())
  displayName String
  notes       String?
  code        String   @unique
  hexColor    String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserConfig {
  id          String              @id @default(uuid())
  userId      String?
  user        User?               @relation(fields: [userId], references: [id])
  displayName String // VD: "Danh sách việc đã ghim"
  description String? // VD: "Chứa các ID của việc làm được user quan tâm"
  code        String
  // Dùng Json để lưu mảng ID hoặc Object phức tạp
  group       UserConfigGroupEnum @default(SYSTEM)
  value       Json
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([userId, code])
}

enum UserConfigGroupEnum {
  SYSTEM
  USER
}

enum RoleEnum {
  USER
  ADMIN
  ACCOUNTING
}

enum AccountProvider {
  GOOGLE
  GITHUB
  MICROSOFT
  FACEBOOK
  LOCAL
}

model FileSystem {
  id    String   @id @default(uuid())
  name  String
  type  String
  size  String
  items Int?
  path  String[]
  color String?

  createdById String
  createdBy   User   @relation("CreatedFiles", fields: [createdById], references: [id])

  visibleToUsers User[] @relation("UserFiles")

  // Link files to jobs
  job   Job?    @relation(fields: [jobId], references: [id])
  jobId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([jobId])
}

model Job {
  id               String             @id @default(uuid())
  no               String             @unique // Job No. example FV-0001
  type             JobType            @relation(fields: [typeId], references: [id])
  typeId           String
  displayName      String
  description      String?
  attachmentUrls   String[]           @default([])
  clientName       String
  incomeCost       Float
  staffCost        Float
  assignee         User[]             @relation("UserJobs") // Member assigned
  createdBy        User               @relation("JobCreator", fields: [createdById], references: [id])
  createdById      String
  paymentChannel   PaymentChannel?    @relation(fields: [paymentChannelId], references: [id])
  paymentChannelId String?
  status           JobStatus          @relation(fields: [statusId], references: [id])
  statusId         String
  activityLog      JobActivityLog[]
  startedAt        DateTime           @default(now())
  priority         JobPriority        @default(MEDIUM)
  files            FileSystem[]
  // isPinned         Boolean            @default(false)
  isPublished      Boolean            @default(false)
  isPaid           Boolean            @default(false)
  dueAt            DateTime
  completedAt      DateTime?
  finishedAt       DateTime?
  paidAt           DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  comments         Comment[]
  statusHistory    JobStatusHistory[]
  pinnedByUsers    PinnedJob[]
  jobDeliveries    JobDelivery[]

  @@index([no])
  @@index([statusId])
  @@index([createdById])
  @@index([priority])
}

model PinnedJob {
  userId   String
  jobId    String
  pinnedAt DateTime @default(now()) // Thời điểm lưu

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Composite ID: Đảm bảo 1 user chỉ pin 1 job được 1 lần
  @@id([userId, jobId])
}

enum JobPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model PaymentChannel {
  id          String   @id @default(uuid())
  displayName String
  hexColor    String?
  logoUrl     String?
  ownerName   String?
  cardNumber  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  jobs Job[]
}

model JobType {
  id          String   @id @default(uuid())
  code        String
  displayName String
  hexColor    String?
  jobs        Job[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobStatus {
  id              String             @id @default(uuid())
  displayName     String
  code            String             @unique
  thumbnailUrl    String?
  hexColor        String
  order           Int                @unique
  icon            String?
  nextStatusOrder Int?
  prevStatusOrder Int?
  jobs            Job[]
  history         JobStatusHistory[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Field mới để phân loại
  systemType JobStatusSystemType @default(STANDARD)

  // Who is allowed to switch a job INTO this status?
  allowedRolesToSet RoleEnum[] @default([ADMIN])

  @@index([order, systemType])
}

// Định nghĩa các nhóm logic hệ thống quan tâm
enum JobStatusSystemType {
  STANDARD // Trạng thái bình thường (To do, In Progress...)
  WAIT_REVIEW
  COMPLETED // Đã làm xong việc (nhưng chưa đóng hồ sơ)
  TERMINATED // Kết thúc vòng đời (Finished, Cancelled, Closed...)
}

model JobDelivery {
  id String @id @default(uuid())

  jobId String

  job Job @relation(fields: [jobId], references: [id])

  userId String // The staff member who delivered

  user User @relation(fields: [userId], references: [id])

  note String? // "Here is the Figma link..."

  link String? // External link

  files String[] // Array of file URLs (from your imageApi)

  // Status of this specific delivery attempt

  status DeliveryStatus @default(PENDING) // PENDING, APPROVED, REJECTED

  adminFeedback String? // If rejected, why?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt
}

enum DeliveryStatus {
  PENDING
  APPROVED
  REJECTED
}

// Tracking chặt chẽ thời gian job nằm ở mỗi trạng thái bao lâu
model JobStatusHistory {
  id String @id @default(uuid())

  // Liên kết với Job
  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Liên kết với Trạng thái (để biết đang ở trạng thái nào)
  statusId String
  status   JobStatus @relation(fields: [statusId], references: [id])

  // Ai là người đã chuyển sang trạng thái này?
  changedById String
  changedBy   User   @relation(fields: [changedById], references: [id])

  // Thời gian
  startedAt DateTime  @default(now()) // Thời điểm bắt đầu vào trạng thái này
  endedAt   DateTime? // Thời điểm rời khỏi trạng thái này. Nếu null nghĩa là Job vẫn đang ở trạng thái này.

  // Optional: Lưu duration (tính bằng giây) để query báo cáo cho nhanh, không cần tính toán lại
  durationSeconds Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([statusId])
  @@index([startedAt])
}

model JobActivityLog {
  id    String @id @default(uuid())
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId String

  previousValue String?
  currentValue  String?

  modifiedAt   DateTime @default(now())
  modifiedBy   User     @relation(fields: [modifiedById], references: [id])
  modifiedById String

  fieldName    String
  activityType ActivityType
  notes        String?

  @@index([jobId, modifiedAt])
  @@index([modifiedById])
}

enum ActivityType {
  CreateJob
  ChangeStatus
  AssignMember
  UnassignMember
  ChangePaymentChannel
  UpdateInformation
  DeleteJob
  DeliverJob
  MarkPaid
}

model Notification {
  id     String @id @default(uuid())
  /**
   * Người nhận thông báo
   */
  userId String
  user   User   @relation("UserNotifications", fields: [userId], references: [id])

  title       String?
  content     String
  imageUrl    String?
  senderId    String?
  redirectUrl String?
  sender      User?              @relation("UserSendedNotifications", fields: [senderId], references: [id])
  type        NotificationType   @default(INFO)
  status      NotificationStatus @default(UNSEEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([userId, status])
  @@index([createdAt])
}

enum NotificationStatus {
  SEEN
  UNSEEN
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  JOB_UPDATE
  DEADLINE_REMINDER
  STATUS_CHANGE
}
